name: Merge and Convert Rules

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Mihomo
        run: |
          # 直接使用官方固定的最新版下载地址，避免解析 JSON 出错
          URL="https://github.com/MetaCubeX/mihomo/releases/download/Prerelease-Alpha/mihomo-linux-amd64-alpha-94e8a86.tar.gz"
          # 如果你追求稳定版，可以使用下面这个动态拼接逻辑
          TAG=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | jq -r .tag_name)
          DOWNLOAD_URL="https://github.com/MetaCubeX/mihomo/releases/download/${TAG}/mihomo-linux-amd64-${TAG}.tar.gz"
          
          echo "Attempting to download: $DOWNLOAD_URL"
          curl -L -o mihomo.tar.gz "$DOWNLOAD_URL"
          
          # 解压
          tar -xzf mihomo.tar.gz
          # 兼容处理：将解压出来的任何以 mihomo-linux-amd64 开头的文件改名为 mihomo
          mv mihomo-linux-amd64* mihomo || mv mihomo-* mihomo || true
          chmod +x mihomo

      - name: Fetch and Merge Rules
        run: |
          # 使用 Raw 链接下载
          curl -sL "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/gfw.list" -o gfw.txt
          curl -sL "https://raw.githubusercontent.com/MetaCubeX/meta-rules-dat/meta/geo/geosite/geolocation-!cn.list" -o not_cn.txt

          # 统计原始行数
          COUNT_GFW=$(grep -v '^#' gfw.txt | grep -v '^$' | wc -l)
          COUNT_NOT_CN=$(grep -v '^#' not_cn.txt | grep -v '^$' | wc -l)

          # 合并并去重
          cat gfw.txt not_cn.txt | grep -v '^#' | grep -v '^$' | sort -u > combined.txt
          COUNT_MERGED=$(wc -l < combined.txt)

          echo "### LOG ###"
          echo "GFW count: $COUNT_GFW"
          echo "Not-CN count: $COUNT_NOT_CN"
          echo "Merged unique count: $COUNT_MERGED"
          echo "###########"

      - name: Convert to MRS
        run: |
          ./mihomo convert-ruleset domain text combined.txt combined.mrs

      - name: Push to Repository
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          mkdir -p release
          mv combined.mrs release/
          git add release/combined.mrs
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update rules: $(date +'%Y-%m-%d')" && git push)
